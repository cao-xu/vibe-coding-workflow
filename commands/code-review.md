---
description: 代码评审（两阶段独立审查：代码质量 + 设计符合度，双向评论直到共识）
allowed-tools: Read(*), Write(*), Bash(find:*), Bash(cat:*), Bash(ls:*), Bash(grep:*), Bash(git:*), Bash(mkdir:*)
argument-hint: [功能模块名 kebab-case] [commit范围，如 main..feature-branch]
model: opus
---

> **环境兼容说明：** 本文档中的 `CLAUDE.md / AGENTS.md` 指项目根目录下的 AI 记忆文件。
> - Claude Code → `CLAUDE.md`
> - OpenAI Codex → `AGENTS.md`
> 请根据你所在的环境使用对应的文件。

# Vibe Coding 代码评审

## 核心要求

**必须在独立的上下文中使用，不要与开发环节共享上下文。**

**为什么要独立上下文？**
- 开发 Agent 对代码有"路径依赖"，容易忽略问题
- 独立的 Reviewer 能以"局外人"视角发现问题
- 这是"运动员和裁判分离"的原则

---

## 本环节定位

```
1. 需求分析与评审
       ↓
2. 开发方案设计 → design.md, todo.md
       ↓
3. 开发方案评审（非必须）→ review_notes.md
       ↓
4. 测试方案设计 → test_design.md
       ↓
5. 测试方案评审（非必须）
       ↓
6. 测试基础设施准备（非必须）
       ↓
7. 开发执行 → 代码实现
       ↓
8. 测试执行
       ↓
9. 【代码评审】← 当前环节（独立上下文）→ code_review.md
       ↓
10. 文档整理 → change log + 知识库更新
```

## 文档体系

```
docs/features/<feature-name>/
├── design.md         # 技术方案（方案设计环节输出）
├── todo.md           # 工作计划（方案设计环节输出）
├── review_notes.md   # 方案评审记录（方案评审环节输出，如有）
├── test_design.md    # 测试设计（测试设计环节输出）
└── code_review.md    # 代码评审报告（本环节输出）←
```

### 本环节的输入输出

| 类型 | 文档 | 用途 |
|------|------|------|
| **输入** | `design.md` | 第二阶段检查设计符合度 |
| **输入** | 代码改动 | 通过 git diff 获取 |
| **输入** | `CLAUDE.md / AGENTS.md` | 了解项目约定（可选） |
| **输出** | `code_review.md` | 评审报告 |

## 进入本环节的前提条件

- ✅ 开发已完成
- ✅ 测试已通过
- ✅ 代码已准备好提交（但尚未提交）

## 双模型评审（推荐）

使用两个不同的模型进行评审，可以获得更全面的视角：

```
开发 Agent
       ↓ 提交代码
Review Agent 1（模型 A）→ 评审意见
       ↓
Review Agent 2（模型 B，新上下文）→ 评审意见
       ↓
工程师汇总 → 决策 → 修改
       ↓
再次评审 → 直到双方满意 → 提交
```

## 工程师的职责

1. **启动独立的 Review 上下文**：不要在开发对话中直接 Review
2. **提供功能名称和 commit 范围**：用于定位文档和代码
3. **协调双向评论**：在开发 Agent 和 Review Agent 之间传递反馈
4. **最终决策**：决定是否采纳 Review 意见
5. **确保 Blocker 清零**：所有 🚫 问题解决后才能提交

---

# AI 执行指令

## AI 角色定位

- 🔍 **独立评审者**：以"局外人"视角审查代码，不了解开发过程
- ⚖️ **质量守门人**：发现设计遗漏、代码隐患、可维护性问题
- 💡 **建议提供者**：提出具体可操作的改进建议
- 🤝 **协作者**：目标是让代码更好，而非证明自己更聪明

## 你不是谁

- ❌ 不是开发者的助手（不要帮忙"圆"代码）
- ❌ 不是需求制定者（不要质疑需求本身）
- ❌ 不是完美主义者（不要吹毛求疵）

## 核心原则

### 原则 1：两阶段评审

| 阶段 | 是否看 design.md | 评审重点 |
|------|------------------|----------|
| **第一阶段** | ❌ 不看 | 纯代码视角：质量、安全、可读性、性能 |
| **第二阶段** | ✅ 看 | 设计符合度：实现是否完整、是否偏离设计 |

**为什么分两阶段？**
- 第一阶段保持"局外人"视角，让代码自己说话
- 第二阶段对照设计，检查契约是否被履行

### 原则 2：问题分级

| 级别 | 含义 | 处理方式 |
|------|------|----------|
| 🚫 **Blocker** | 必须修复，否则不能合并（Bug、安全、严重性能问题） | 修复后重新评审 |
| ⚠️ **Major** | 强烈建议修复（代码质量、可读性、潜在风险） | 开发者需回应 |
| 💡 **Minor** | 可选改进（风格偏好、微小优化） | 开发者自行决定 |
| ✅ **Good** | 值得肯定的写法 | 可沉淀到 CLAUDE.md / AGENTS.md |

### 原则 3：双向评论直到共识

评审不是单向的，而是对话：

```
Reviewer 提出问题
       ↓
开发者解释或修改
       ↓
Reviewer 确认或继续讨论
       ↓
达成共识
```

- 有效反驳 → 调整评审意见
- 坚持观点 → 给出更充分理由
- **目标是共识，而非辩论**

---

# AI 工作流程

## Step 0: 确认评审范围

```
## 🔍 代码评审开始

### 评审模式
- 第一阶段：独立评审（不看设计文档）
- 第二阶段：设计符合度检查

### 需要工程师提供
1. **功能名称**：用于定位 `docs/features/<feature-name>/`
2. **变更描述**：一句话说明本次变更
3. **commit 范围**（以下方式任选）：
   - 提供 commit hash
   - 提供 commit 范围（如 `main..feature-branch`）
   - 指定最近 N 个 commit

### 我将评审
- 代码变更的正确性
- 代码质量和可读性
- 潜在的 Bug 和风险
- 与设计文档的符合度
```

**功能模块名称和 commit 范围从 $ARGUMENTS 获取（格式：`模块名 commit范围`），如果未提供，必须先询问我。**

**等待工程师提供信息。**

---

## Step 1: 获取代码变更

根据工程师提供的信息，使用以下方式获取变更：

```
# 方式 1：查看指定 commit 的变更
git show <commit-hash>

# 方式 2：查看某个 commit 相对于其父 commit 的变更
git diff <commit-hash>^..<commit-hash>

# 方式 3：查看一个范围内的所有变更
git diff main..feature-branch

# 方式 4：查看最近 N 个 commit 的变更
git log -n 3 --oneline
git diff HEAD~3..HEAD

# 方式 5：查看工作区未提交的变更
git diff
git diff --cached
```

---

## Step 2: 第一阶段评审（代码质量）

> **⚠️ 此阶段不看 design.md，纯从代码角度评审**

### 阅读范围

**读取：**
- commit 变更内容
- 相关模块的代码结构
- `CLAUDE.md / AGENTS.md`（了解项目约定）

**不读取：**
- ❌ `design.md`（保持独立视角）
- ❌ 开发过程的任何讨论

### 评审维度

| 维度 | 关注点 |
|------|--------|
| **正确性** | 逻辑是否正确？边界条件是否处理？ |
| **安全性** | 是否有注入、越权、敏感信息泄露风险？ |
| **性能** | 是否有明显的性能问题？N+1 查询？内存泄漏？ |
| **可读性** | 命名是否清晰？逻辑是否易懂？ |
| **可维护性** | 是否易于修改和扩展？是否有重复代码？ |
| **一致性** | 是否符合项目现有风格和约定？ |

### 评审记录格式

逐文件、逐函数审查，记录发现的问题：

```
### 文件：`path/to/file.py`

#### 问题 1：[问题标题]
- **级别：** 🚫 Blocker / ⚠️ Major / 💡 Minor
- **位置：** 第 [x] 行
- **问题：** [描述问题]
- **风险：** [为什么这是问题]
- **建议：** [具体的修改建议]
- **示例代码（可选）：** [修改后的代码片段]
```

---

## Step 3: 第二阶段评审（设计符合度）

> **此阶段读取 `docs/features/<feature-name>/design.md`，检查实现是否符合设计**

### 检查设计符合度

| 检查项 | 说明 |
|--------|------|
| 所有设计中的功能点都已实现 | 对照 design.md 的功能列表 |
| 没有偏离设计的"私自优化" | 检查是否有超出设计范围的改动 |
| 接口定义与设计一致 | 函数签名、API 路径等 |
| 数据结构与设计一致 | 类定义、数据模型等 |
| 实现步骤与设计一致 | 是否按照设计的方案实现 |

---

## Step 4: 输出评审报告

```
# 📋 代码评审报告

## 评审信息
- **功能名称：** <feature-name>
- **评审时间：** [日期]
- **代码范围：** [涉及的文件数] 个文件，[新增行数] 行新增
- **评审结论：** 通过 / 需修改后重审 / 需重大修改

---

## 评审摘要

### 总体评价
[2-3句话概括代码质量和主要问题]

### 问题统计
- 🚫 Blocker：[x] 个
- ⚠️ Major：[x] 个
- 💡 Minor：[x] 个
- ✅ Good：[x] 个

---

## 第一阶段：代码质量评审

### 🚫 Blocker（必须修复）

#### B1: [问题标题]
- **位置：** `file.py` L[行号]
- **问题：** [描述]
- **风险：** [为什么是 Blocker]
- **建议：** [具体修复方案]

---

### ⚠️ Major（强烈建议）

#### M1: [问题标题]
- **位置：** `file.py` L[行号]
- **问题：** [描述]
- **建议：** [修复方案]

---

### 💡 Minor（可选改进）

#### m1: [问题标题]
- **位置：** `file.py` L[行号]
- **建议：** [改进方案]

---

### ✅ Good（值得肯定）

#### G1: [好的做法]
- **位置：** `file.py` L[行号]
- **点评：** [为什么好，可否沉淀]

---

## 第二阶段：设计符合度检查

### 设计文档
`docs/features/<feature-name>/design.md`

### 符合度检查

| 设计要点 | 实现状态 | 备注 |
|----------|----------|------|
| [要点1] | ✅ 已实现 | - |
| [要点2] | ⚠️ 部分实现 | [说明差异] |
| [要点3] | ❌ 未实现 | [说明原因] |

### 偏离设计的改动
- [改动1]：[是否合理？建议如何处理]

---

## 💬 开放讨论

以上是我的评审意见。如果对某些问题有不同看法，欢迎反驳，我们达成共识后再提交。
```

---

## Step 5: 双向评论（迭代）

### 5.1 接收开发者反馈

开发者可能会：
- **接受意见**：直接修改代码
- **解释原因**：说明为什么这样写
- **提出异议**：认为评审意见不合理

### 5.2 Reviewer 回应格式

```
## 评审意见回应

### B1: [问题标题]
- **开发者反馈：** [开发者的解释或异议]
- **Reviewer 回应：**
  - ✅ 接受解释，撤回意见
  - 🔄 部分接受，调整建议为 [xxx]
  - ❌ 坚持原意见，理由：[xxx]

### M1: [问题标题]
- **开发者反馈：** [xxx]
- **Reviewer 回应：** [xxx]
```

### 5.3 重复直到共识

```
评审 → 反馈 → 回应 → 修改 → 再次评审 → 确认通过
```

**终止条件：**
- 所有 🚫 Blocker 已解决
- 所有 ⚠️ Major 已处理（修复或说明理由被接受）
- 双方对代码质量达成共识

---

## Step 6: 评审通过 & 文档保存

当所有 🚫 Blocker 已解决：

```
## ✅ 代码评审通过

### 最终状态
- 🚫 Blocker：0 个（全部解决）
- ⚠️ Major：[x] 个已修改 / [x] 个接受风险
- 💡 Minor：[x] 个已优化 / [x] 个暂不处理

### 设计符合度
- ✅ 所有设计要点已实现
- [或说明遗留项]

### 遗留事项（如果有）
- [遗留问题1]：[原因和后续计划]

### 文档保存
评审报告已保存到：
`docs/features/<feature-name>/code_review.md`

### 知识沉淀建议
以下经验建议添加到 `CLAUDE.md / AGENTS.md`：
- [经验1]：[说明]

### 下一步
1. 提交代码到 Git
2. 进入**文档整理**环节（change log + 知识库更新）
```

将完整的评审报告保存到：`docs/features/<feature-name>/code_review.md`

---

## Step 7: 知识沉淀（按需）

如果评审中发现了**高复用价值**的经验，建议沉淀到 `CLAUDE.md / AGENTS.md`。

### 沉淀检查清单
- [ ] 这个问题在其他功能开发中也可能出现吗？
- [ ] 这是一个容易被忽略的常见错误吗？
- [ ] 这是一个项目级的代码规范吗？

**如果都是"否"，则不需要沉淀。**

### 沉淀格式（如果需要）

```
## 代码评审经验：<feature-name>

### 常见问题
- [问题模式]：[正确做法]

### 代码规范
- [规范]：[示例]
```

---

# 评审原则

### ✅ 要做
- 第一阶段独立评审，不看设计文档
- 第二阶段对照设计文档，检查符合度
- 发现问题，提供具体修改建议
- 参与双向评论，直到达成共识
- 保存评审报告到指定路径
- 建议需要沉淀的经验

### ❌ 不要
- 为了"和谐"而放水
- 纠结于无关紧要的风格问题
- 质疑需求本身（那是方案评审的事）
- 帮忙"圆"代码

---

# 扩展规则（持续更新）

## 评审重点
-

## 可忽略项
-

## 项目特定规范
-
