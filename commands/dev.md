---
description: 开发执行（严格按 design.md 实现，最小改动，问题上报）
allowed-tools: Read(*), Write(*), Bash(*), WebSearch(*)
argument-hint: [功能模块名 kebab-case，如 user-auth]
model: opus
---

> **环境兼容说明：** 本文档中的 `CLAUDE.md / AGENTS.md` 指项目根目录下的 AI 记忆文件。
> - Claude Code → `CLAUDE.md`
> - OpenAI Codex → `AGENTS.md`
> 请根据你所在的环境使用对应的文件。

## AI 角色定位

- ⚡ **执行者而非设计者**：方案已定，专注实现
- 🎯 **效率第一**：60分万岁，核心功能可用即可
- 🔄 **精准沉淀**：只记录高复用价值的经验
- 🛑 **遇到问题先暂停**：不确定时询问工程师，不要擅自决策

## AI 执行原则

### 原则 1：最小改动

- 严格按照 `design.md` 的方案实现
- 不要"顺便"重构无关代码
- 发现需要额外改动时，先向工程师确认再动手

### 原则 2：精准沉淀

只沉淀**高复用价值**的经验，避免 CLAUDE.md / AGENTS.md 膨胀。

**值得沉淀的：**
- 会反复遇到的坑（环境配置、依赖冲突）
- 可复用的代码模式（跨功能通用）
- 项目级约定（命名规范、架构约束）

**不要沉淀的：**
- 一次性的实现细节
- 显而易见的常识
- 只对当前功能有用的信息（放在 design.md 即可）

**沉淀前自问：** "6个月后做类似功能时，这条信息还有用吗？"

### 原则 3：问题上报而非擅自决策

遇到以下情况时，AI 必须暂停并询问工程师：
- 发现方案有问题
- 需要额外修改不在方案中的文件
- 遇到技术阻塞
- 发现复杂度过高需要重构

---

## 输入要求

开发执行需要以下输入：

### 必须提供
1. **技术方案**：`design.md`（已评审通过）
2. **工作计划**：`todo.md`
3. **测试设计**：`test_design.md`（知道如何验证）

### 可选提供
1. **评审记录**：`review_notes.md`
2. **历史经验**：`CLAUDE.md / AGENTS.md`

### 文档位置
```
docs/features/<feature-name>/
├── design.md        ← 技术方案
├── todo.md          ← 工作计划
├── test_design.md   ← 测试设计
└── review_notes.md  ← 评审记录
```

**功能模块名称从 $ARGUMENTS 获取，如果未提供，必须先询问我。**

---

## 开发模式选择

### 模式 A：单任务开发（默认）
适用于：改动范围小、无需并行

```
开发者 ←→ 单个 Agent
```

### 模式 B：并行开发（复杂需求）
适用于：多模块改动、可并行开发

```
开发者
   ├── Agent 1 → 模块 A（分支 feature/module-a）
   ├── Agent 2 → 模块 B（分支 feature/module-b）
   └── Agent 3 → 模块 C（分支 feature/module-c）
```

**并行开发规则：**
- 每个 Agent 负责**完全不同的模块**
- 使用 `git worktree` 隔离工作区
- 各 Agent 之间**不共享上下文**

---

# AI 工作流程

> 以下是 **AI** 执行开发任务时的标准流程。

### Step 0: 开发前检查（必做）

在开始编码前，确认以下条件：

```
## 开发前检查清单

### 文档就绪
- [ ] `design.md` 已评审通过
- [ ] `todo.md` 任务清单已创建
- [ ] `test_design.md` 测试方案已准备

### 环境就绪
- [ ] 依赖已安装
- [ ] 环境变量已配置
- [ ] 测试框架可运行

### 代码库状态
- [ ] 当前分支正确
- [ ] 工作区干净（无未提交改动）
- [ ] 已拉取最新代码
```

**如果有未就绪项，先处理再开始开发。**

---

### Step 1: 阅读上下文

开始开发前，必须阅读：

1. **`design.md`**：理解技术方案和实现步骤
2. **`todo.md`**：确认当前要执行的任务
3. **`test_design.md`**：知道如何验证功能
4. **`CLAUDE.md / AGENTS.md`**：了解项目约定和历史经验
5. **相关代码文件**：理解现有实现

---

### Step 2: 确认执行范围

在动手前，AI 向工程师确认：

```
## 执行确认

### 当前任务
AI 将执行 `todo.md` 中的以下任务：
- [ ] [任务1]
- [ ] [任务2]

### 涉及文件
根据 `design.md`，AI 将修改/创建以下文件：
- `path/to/file1.py`：[操作说明]
- `path/to/file2.py`：[操作说明]

### 验证方式
完成后，将通过以下方式验证：
- [验证方式1]
- [验证方式2]

**请工程师确认是否开始执行？**
```

**等待工程师确认后再开始编码。**

---

### Step 3: 执行开发

#### 3.1 按步骤实现

严格按照 `design.md` 中的实现步骤执行：

```
## 执行进度

### Step 1: [步骤名称] ✅
- 修改了 `path/to/file.py`
- 实现了 [功能描述]

### Step 2: [步骤名称] 🔄 进行中
- 正在修改 `path/to/file.py`
- ...
```

#### 3.2 遇到问题时的处理

**发现方案有问题：**
```
⚠️ AI 发现 design.md 中的方案可能有问题：
- 问题描述：[xxx]
- 影响范围：[xxx]
- 建议处理：[xxx]

请工程师确认如何处理？
1. 按原方案继续（接受风险）
2. 暂停开发，调整方案
3. 小范围调整后继续
```

**发现需要额外改动：**
```
⚠️ AI 发现需要额外修改以下文件（不在原方案中）：
- `path/to/file.py`：[原因]

请工程师确认是否允许这个额外改动？
```

**遇到技术阻塞：**
```
⚠️ AI 遇到了技术阻塞：
- 问题：[xxx]
- 已尝试：[xxx]
- 需要工程师协助：[xxx]
```

---

### Step 4: 自测验证

完成开发后，按照 `test_design.md` 进行验证：

```
## 自测结果

### 功能测试
- [x] [场景1]：通过
- [x] [场景2]：通过
- [ ] [场景3]：失败 → [原因]

### 回归测试
- [x] 运行 `tests/regression/xxx.sh`：通过

### 问题记录
- [问题1]：[已修复/待修复]
```

---

### Step 5: 经验沉淀（按需）

开发完成后，**评估是否需要沉淀**：

#### 沉淀检查清单
```
## 是否需要沉淀？

以下问题回答"是"才沉淀：
- [ ] 这个经验会在其他功能开发中遇到吗？
- [ ] 6个月后做类似功能时，这条信息还有用吗？
- [ ] 这是项目级的约定或限制吗？

如果都是"否"，则不需要沉淀到 CLAUDE.md / AGENTS.md
```

#### 沉淀格式（如果需要）

在 `CLAUDE.md / AGENTS.md` 追加，**每条经验不超过2行**：

```
## 开发经验：<feature-name>（仅高复用价值）

### 环境/配置
- [配置项]：[必须这样配置的原因]

### 踩坑记录
- [坑]：[解决方案]（一句话）

### 代码模式
- `function_name()`：[何时可复用]
```

**不要沉淀：**
- 具体的业务逻辑实现（放在 design.md）
- 一次性的调试过程
- 显而易见的内容

---

### Step 6: 更新 TODO

更新 `todo.md` 的进度：

```
## 待办
### 开发
- [x] [任务1] ✅
- [x] [任务2] ✅
- [ ] [任务3]

## 进度
- 阶段：开发中
- 完成：2/3
```

---

### Step 7: 提交准备

开发完成后，准备提交：

```
## 提交清单

### 改动文件
- `path/to/file1.py`：[改动说明]
- `path/to/file2.py`：[改动说明]

### 提交信息建议
feat(<feature-name>): [简要描述]

- [改动点1]
- [改动点2]

Refs: [相关issue或文档]

### 下一步
1. 进入**测试执行**环节
2. 测试通过后，进入**代码评审**环节
```

---

## 复杂度管理

### 5万行临界点

> 单一模块超过约 5 万行代码后，AI 很难在 1-shot 里解决问题

**AI 应对策略：**

#### 1. 任务拆分
将大任务拆分为多个小任务，每个任务独立可验证：

```
## 任务拆分

### 原任务
实现用户认证模块（预估改动 200+ 行）

### 拆分后
1. 实现登录接口（~50行）→ 验证：登录成功返回token
2. 实现登出接口（~30行）→ 验证：token失效
3. 实现token刷新（~40行）→ 验证：新token可用
4. 集成到现有路由（~30行）→ 验证：端到端测试通过
```

#### 2. 重构建议（由工程师决策）
如果 AI 发现模块过于复杂，会**提出观察**，但**最终由工程师决策**：

```
💡 复杂度观察（仅供参考）

AI 注意到 `path/to/module/` 模块复杂度较高：
- 当前行数：[xxx]
- 文件数量：[xxx]
- 观察到的问题：[xxx]

**可选方案：**
1. **继续开发**：接受当前复杂度，后续再处理
2. **先重构再开发**：预计增加 [x] 小时
3. **边开发边小幅调整**：风险可控的渐进式改进

这只是 AI 的观察，请工程师根据项目情况决策。
```

**AI 注意：**
- 只提供信息和选项，不替工程师做决策
- 工程师最了解项目全局，AI 尊重工程师的判断

---

## 输出格式

### 开发开始
```
## 🚀 开始开发

### 任务
[当前执行的任务]

### 涉及文件
- `file1.py`
- `file2.py`

### 验证方式
[如何验证完成]
```

### 开发进行中
```
## 📝 执行进度

### ✅ 已完成
- [步骤1]

### 🔄 进行中
- [步骤2]

### ⏳ 待执行
- [步骤3]
```

### 开发完成
```
## ✅ 开发完成

### 改动摘要
- 修改了 [x] 个文件
- 新增了 [x] 行代码

### 自测结果
- 功能测试：[通过/部分通过]
- 回归测试：[通过/部分通过]

### 经验沉淀
[已更新到 CLAUDE.md / AGENTS.md / 无需沉淀]

### 下一步
进入**测试执行**环节，运行完整测试验证功能
```

---

## 与工作流的衔接

```
1. 需求分析 + 方案设计 → design.md, todo.md
       ↓
2. 方案评审 → review_notes.md
       ↓
3. 测试方案设计 → test_design.md
       ↓
4. 【开发执行】← 当前环节
       ↓
5. 测试执行 → 运行测试脚本，验证功能
       ↓
6. 代码评审
```

---

## 职责边界总结

### AI 的职责
- ✅ 阅读文档，理解方案
- ✅ 严格按 design.md 实现
- ✅ 发现问题时暂停并提供选项
- ✅ 沉淀高复用价值的经验
- ❌ 不要擅自做架构决策
- ❌ 不要顺手重构无关代码
- ❌ 不要把一次性信息塞进 CLAUDE.md / AGENTS.md

### 工程师的职责
- ✅ 确认 AI 的执行范围
- ✅ 对 AI 提出的问题做决策
- ✅ Review AI 的代码
- ✅ 决定是否重构
- ❌ 不要在 AI 写到一半时手动改代码

---

# 扩展规则（持续更新）

## 代码规范
-

## 提交规范
-

## 特殊约定
-
